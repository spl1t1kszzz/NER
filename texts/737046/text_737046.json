{
  "entities": [
    [
      [
        15,
        17
      ],
      [
        95,
        97
      ],
      [
        188,
        204
      ],
      [
        486,
        504
      ],
      [
        691,
        709
      ],
      [
        974,
        992
      ],
      [
        1154,
        1172
      ],
      [
        1373,
        1391
      ],
      [
        2669,
        2671
      ],
      [
        5421,
        5423
      ],
      [
        10112,
        10130
      ],
      [
        22746,
        22763
      ],
      [
        22769,
        22785
      ],
      [
        22799,
        22815
      ]
    ],
    [
      [
        15,
        26
      ],
      [
        95,
        106
      ],
      [
        22124,
        22135
      ]
    ],
    [
      [
        18,
        26
      ],
      [
        98,
        106
      ],
      [
        415,
        423
      ],
      [
        443,
        451
      ],
      [
        1226,
        1235
      ],
      [
        1496,
        1505
      ],
      [
        2105,
        2114
      ],
      [
        2978,
        2987
      ],
      [
        3408,
        3417
      ],
      [
        3625,
        3634
      ],
      [
        3794,
        3804
      ],
      [
        3976,
        3985
      ],
      [
        4086,
        4097
      ],
      [
        4172,
        4181
      ],
      [
        4426,
        4435
      ],
      [
        4512,
        4521
      ],
      [
        4748,
        4758
      ],
      [
        4857,
        4866
      ],
      [
        4871,
        4879
      ],
      [
        4879,
        4887
      ],
      [
        5763,
        5772
      ],
      [
        7725,
        7733
      ],
      [
        8369,
        8379
      ],
      [
        13606,
        13615
      ],
      [
        13833,
        13842
      ],
      [
        15078,
        15086
      ],
      [
        17053,
        17061
      ],
      [
        20505,
        20514
      ],
      [
        20578,
        20588
      ],
      [
        20773,
        20782
      ],
      [
        20977,
        20986
      ],
      [
        21109,
        21118
      ],
      [
        21149,
        21158
      ],
      [
        21432,
        21441
      ],
      [
        21506,
        21515
      ],
      [
        21570,
        21579
      ],
      [
        21667,
        21675
      ],
      [
        21677,
        21684
      ],
      [
        21845,
        21854
      ],
      [
        22393,
        22401
      ],
      [
        22412,
        22415
      ]
    ],
    [
      [
        30,
        37
      ],
      [
        110,
        117
      ],
      [
        427,
        434
      ],
      [
        670,
        677
      ],
      [
        723,
        730
      ],
      [
        838,
        845
      ],
      [
        905,
        912
      ],
      [
        940,
        947
      ],
      [
        992,
        999
      ],
      [
        1102,
        1116
      ],
      [
        1174,
        1176
      ],
      [
        1333,
        1340
      ],
      [
        1700,
        1707
      ],
      [
        2085,
        2092
      ],
      [
        2758,
        2765
      ],
      [
        2870,
        2884
      ],
      [
        2885,
        2892
      ],
      [
        4479,
        4486
      ],
      [
        4583,
        4590
      ],
      [
        4613,
        4620
      ],
      [
        4686,
        4700
      ],
      [
        5877,
        5884
      ],
      [
        7280,
        7287
      ],
      [
        7463,
        7470
      ],
      [
        8456,
        8463
      ],
      [
        13777,
        13784
      ],
      [
        14604,
        14611
      ],
      [
        16799,
        16806
      ],
      [
        16915,
        16922
      ],
      [
        16961,
        16963
      ],
      [
        17101,
        17108
      ],
      [
        17119,
        17126
      ],
      [
        17174,
        17181
      ],
      [
        17242,
        17256
      ],
      [
        17359,
        17366
      ],
      [
        17369,
        17376
      ],
      [
        17526,
        17533
      ],
      [
        17662,
        17669
      ],
      [
        17959,
        17966
      ],
      [
        18081,
        18088
      ],
      [
        19458,
        19465
      ],
      [
        19571,
        19578
      ],
      [
        19924,
        19931
      ],
      [
        19941,
        19948
      ],
      [
        19968,
        19975
      ],
      [
        20430,
        20437
      ],
      [
        20489,
        20496
      ],
      [
        20541,
        20548
      ],
      [
        20715,
        20722
      ],
      [
        20725,
        20732
      ],
      [
        20854,
        20861
      ],
      [
        22139,
        22146
      ],
      [
        22684,
        22691
      ]
    ],
    [
      [
        49,
        57
      ],
      [
        129,
        137
      ],
      [
        241,
        249
      ],
      [
        331,
        340
      ],
      [
        2632,
        2641
      ],
      [
        22438,
        22448
      ]
    ],
    [
      [
        206,
        233
      ],
      [
        586,
        589
      ],
      [
        22763,
        22766
      ],
      [
        22815,
        22842
      ]
    ],
    [
      [
        281,
        287
      ],
      [
        792,
        798
      ],
      [
        1260,
        1266
      ],
      [
        1401,
        1407
      ],
      [
        1525,
        1531
      ],
      [
        1567,
        1569
      ],
      [
        1729,
        1735
      ],
      [
        1853,
        1859
      ],
      [
        4933,
        4939
      ],
      [
        4951,
        4957
      ],
      [
        5087,
        5093
      ],
      [
        5896,
        5903
      ],
      [
        6178,
        6184
      ],
      [
        6769,
        6775
      ],
      [
        6929,
        6936
      ],
      [
        7028,
        7034
      ],
      [
        7483,
        7489
      ],
      [
        7522,
        7528
      ],
      [
        7820,
        7826
      ],
      [
        8489,
        8495
      ],
      [
        12039,
        12045
      ],
      [
        13626,
        13632
      ],
      [
        14183,
        14189
      ],
      [
        14524,
        14530
      ],
      [
        18484,
        18491
      ]
    ],
    [
      [
        305,
        317
      ],
      [
        1352,
        1364
      ]
    ],
    [
      [
        318,
        324
      ],
      [
        590,
        596
      ],
      [
        824,
        830
      ],
      [
        1295,
        1302
      ],
      [
        1365,
        1372
      ],
      [
        1431,
        1437
      ],
      [
        1860,
        1866
      ],
      [
        1947,
        1953
      ],
      [
        2151,
        2157
      ],
      [
        2268,
        2274
      ],
      [
        2285,
        2292
      ],
      [
        2391,
        2397
      ],
      [
        2566,
        2572
      ],
      [
        2714,
        2721
      ],
      [
        5030,
        5036
      ],
      [
        5048,
        5054
      ],
      [
        5065,
        5071
      ],
      [
        5462,
        5468
      ],
      [
        6262,
        6269
      ],
      [
        6316,
        6322
      ],
      [
        6349,
        6356
      ],
      [
        6529,
        6536
      ],
      [
        7066,
        7072
      ],
      [
        9898,
        9904
      ],
      [
        10144,
        10150
      ],
      [
        10221,
        10227
      ],
      [
        10250,
        10256
      ],
      [
        10272,
        10276
      ],
      [
        10357,
        10360
      ],
      [
        10688,
        10694
      ],
      [
        11248,
        11254
      ],
      [
        11470,
        11476
      ],
      [
        11606,
        11612
      ],
      [
        11725,
        11732
      ],
      [
        13411,
        13417
      ],
      [
        22029,
        22035
      ]
    ],
    [
      [
        326,
        340
      ],
      [
        4448,
        4463
      ],
      [
        4541,
        4550
      ]
    ],
    [
      [
        341,
        343
      ],
      [
        403,
        407
      ],
      [
        521,
        523
      ],
      [
        2233,
        2236
      ],
      [
        2642,
        2644
      ],
      [
        4819,
        4821
      ],
      [
        4867,
        4870
      ],
      [
        5159,
        5161
      ],
      [
        5773,
        5775
      ],
      [
        5919,
        5921
      ],
      [
        6587,
        6589
      ],
      [
        7566,
        7568
      ],
      [
        7611,
        7613
      ],
      [
        7655,
        7658
      ],
      [
        7746,
        7748
      ],
      [
        8433,
        8435
      ],
      [
        9758,
        9761
      ],
      [
        9807,
        9809
      ],
      [
        10459,
        10461
      ],
      [
        10944,
        10946
      ],
      [
        11551,
        11553
      ],
      [
        11554,
        11558
      ],
      [
        11589,
        11593
      ],
      [
        11636,
        11641
      ],
      [
        13511,
        13513
      ],
      [
        13564,
        13566
      ],
      [
        13599,
        13605
      ],
      [
        13747,
        13749
      ],
      [
        13826,
        13832
      ],
      [
        13974,
        13976
      ],
      [
        14091,
        14097
      ],
      [
        15380,
        15382
      ],
      [
        16146,
        16148
      ],
      [
        16544,
        16549
      ],
      [
        17029,
        17031
      ],
      [
        17049,
        17052
      ],
      [
        17182,
        17184
      ],
      [
        17923,
        17925
      ],
      [
        18058,
        18060
      ],
      [
        18256,
        18258
      ],
      [
        18695,
        18697
      ],
      [
        18817,
        18819
      ],
      [
        20109,
        20114
      ],
      [
        20702,
        20707
      ],
      [
        20901,
        20905
      ],
      [
        20937,
        20943
      ],
      [
        21102,
        21108
      ],
      [
        21311,
        21313
      ],
      [
        21640,
        21642
      ],
      [
        21784,
        21788
      ],
      [
        21813,
        21816
      ],
      [
        21869,
        21871
      ],
      [
        21981,
        21985
      ],
      [
        22047,
        22049
      ],
      [
        22112,
        22116
      ],
      [
        22162,
        22164
      ]
    ],
    [
      [
        508,
        520
      ],
      [
        22149,
        22161
      ]
    ],
    [
      [
        540,
        547
      ],
      [
        601,
        603
      ],
      [
        6129,
        6136
      ],
      [
        7542,
        7550
      ],
      [
        7674,
        7682
      ],
      [
        7784,
        7791
      ],
      [
        10489,
        10496
      ],
      [
        10925,
        10934
      ],
      [
        11048,
        11055
      ],
      [
        11066,
        11068
      ],
      [
        21540,
        21547
      ],
      [
        21726,
        21733
      ],
      [
        21769,
        21771
      ],
      [
        21907,
        21914
      ],
      [
        22193,
        22201
      ],
      [
        22227,
        22229
      ]
    ],
    [
      [
        551,
        570
      ],
      [
        6098,
        6115
      ],
      [
        22205,
        22224
      ]
    ],
    [
      [
        586,
        596
      ],
      [
        9964,
        9974
      ],
      [
        22244,
        22255
      ]
    ],
    [
      [
        604,
        617
      ],
      [
        10072,
        10085
      ],
      [
        22230,
        22243
      ]
    ],
    [
      [
        619,
        643
      ],
      [
        6323,
        6347
      ],
      [
        9906,
        9930
      ],
      [
        9986,
        10010
      ],
      [
        10021,
        10045
      ],
      [
        10046,
        10070
      ],
      [
        10072,
        10098
      ],
      [
        11715,
        11724
      ],
      [
        22257,
        22281
      ],
      [
        22705,
        22729
      ]
    ],
    [
      [
        680,
        688
      ],
      [
        963,
        971
      ],
      [
        1143,
        1151
      ],
      [
        5973,
        5981
      ],
      [
        6856,
        6863
      ]
    ],
    [
      [
        773,
        778
      ],
      [
        7125,
        7130
      ],
      [
        7196,
        7200
      ],
      [
        15291,
        15296
      ],
      [
        16080,
        16085
      ],
      [
        16087,
        16090
      ],
      [
        18011,
        18016
      ],
      [
        18113,
        18118
      ],
      [
        18290,
        18295
      ],
      [
        18779,
        18784
      ],
      [
        21236,
        21241
      ],
      [
        21266,
        21271
      ],
      [
        21285,
        21287
      ],
      [
        21298,
        21303
      ],
      [
        22174,
        22179
      ],
      [
        22291,
        22296
      ]
    ],
    [
      [
        783,
        791
      ],
      [
        4942,
        4950
      ],
      [
        5039,
        5047
      ],
      [
        7006,
        7014
      ],
      [
        7474,
        7482
      ],
      [
        7811,
        7819
      ],
      [
        12030,
        12038
      ],
      [
        13617,
        13625
      ],
      [
        17451,
        17459
      ],
      [
        22184,
        22192
      ]
    ],
    [
      [
        811,
        823
      ],
      [
        1418,
        1430
      ],
      [
        2138,
        2150
      ],
      [
        2419,
        2431
      ],
      [
        5017,
        5029
      ],
      [
        5130,
        5142
      ],
      [
        5449,
        5461
      ],
      [
        7053,
        7065
      ],
      [
        9885,
        9897
      ],
      [
        10666,
        10678
      ],
      [
        10984,
        10996
      ],
      [
        11225,
        11237
      ],
      [
        11620,
        11632
      ],
      [
        11807,
        11819
      ],
      [
        11948,
        11960
      ],
      [
        13398,
        13410
      ],
      [
        13645,
        13657
      ],
      [
        14532,
        14544
      ],
      [
        16114,
        16126
      ],
      [
        16230,
        16242
      ]
    ],
    [
      [
        831,
        837
      ],
      [
        4505,
        4511
      ],
      [
        7336,
        7343
      ],
      [
        7446,
        7453
      ],
      [
        14993,
        15001
      ],
      [
        15301,
        15308
      ],
      [
        15465,
        15472
      ],
      [
        17093,
        17100
      ],
      [
        17112,
        17118
      ],
      [
        17166,
        17173
      ],
      [
        17334,
        17341
      ],
      [
        17405,
        17412
      ],
      [
        17760,
        17767
      ],
      [
        18003,
        18010
      ],
      [
        18282,
        18289
      ],
      [
        18771,
        18778
      ],
      [
        19451,
        19457
      ],
      [
        19490,
        19496
      ],
      [
        19562,
        19570
      ],
      [
        19640,
        19648
      ],
      [
        19949,
        19955
      ],
      [
        19990,
        19997
      ],
      [
        20498,
        20504
      ],
      [
        20571,
        20577
      ],
      [
        20753,
        20759
      ],
      [
        21032,
        21039
      ],
      [
        21046,
        21053
      ],
      [
        21141,
        21148
      ]
    ],
    [
      [
        861,
        867
      ],
      [
        5190,
        5196
      ],
      [
        5239,
        5245
      ],
      [
        7502,
        7508
      ],
      [
        9792,
        9798
      ],
      [
        13547,
        13553
      ],
      [
        18357,
        18363
      ],
      [
        18501,
        18507
      ],
      [
        19535,
        19541
      ]
    ],
    [
      [
        861,
        875
      ],
      [
        9867,
        9881
      ],
      [
        17137,
        17151
      ],
      [
        17204,
        17218
      ],
      [
        17220,
        17222
      ],
      [
        17423,
        17437
      ],
      [
        22691,
        22705
      ]
    ],
    [
      [
        889,
        904
      ],
      [
        3877,
        3886
      ],
      [
        3993,
        4006
      ],
      [
        17892,
        17901
      ],
      [
        20457,
        20471
      ],
      [
        20475,
        20488
      ]
    ],
    [
      [
        913,
        916
      ],
      [
        22339,
        22342
      ]
    ],
    [
      [
        929,
        935
      ],
      [
        22355,
        22361
      ]
    ],
    [
      [
        1020,
        1025
      ],
      [
        1027,
        1034
      ]
    ],
    [
      [
        1249,
        1259
      ],
      [
        8479,
        8488
      ]
    ],
    [
      [
        1268,
        1277
      ],
      [
        10203,
        10220
      ],
      [
        11685,
        11693
      ],
      [
        22020,
        22028
      ]
    ],
    [
      [
        1280,
        1294
      ]
    ],
    [
      [
        1311,
        1316
      ],
      [
        1318,
        1325
      ]
    ],
    [
      [
        1440,
        1455
      ],
      [
        2160,
        2176
      ],
      [
        2295,
        2310
      ]
    ],
    [
      [
        1473,
        1476
      ]
    ],
    [
      [
        1487,
        1491
      ],
      [
        1898,
        1902
      ],
      [
        7740,
        7744
      ],
      [
        7772,
        7776
      ]
    ],
    [
      [
        1492,
        1495
      ]
    ],
    [
      [
        1492,
        1505
      ],
      [
        1507,
        1514
      ]
    ],
    [
      [
        1542,
        1552
      ],
      [
        6074,
        6083
      ]
    ],
    [
      [
        1585,
        1594
      ]
    ],
    [
      [
        1595,
        1602
      ],
      [
        5113,
        5119
      ]
    ],
    [
      [
        1624,
        1635
      ]
    ],
    [
      [
        1636,
        1660
      ],
      [
        2057,
        2081
      ]
    ],
    [
      [
        1708,
        1727
      ]
    ],
    [
      [
        1739,
        1752
      ],
      [
        2012,
        2025
      ],
      [
        2514,
        2526
      ],
      [
        19815,
        19827
      ]
    ],
    [
      [
        1813,
        1830
      ]
    ],
    [
      [
        1903,
        1928
      ]
    ],
    [
      [
        1991,
        2003
      ],
      [
        2462,
        2474
      ]
    ],
    [
      [
        2040,
        2044
      ]
    ],
    [
      [
        2045,
        2056
      ]
    ],
    [
      [
        2213,
        2231
      ]
    ],
    [
      [
        2260,
        2267
      ]
    ],
    [
      [
        2336,
        2362
      ]
    ],
    [
      [
        2401,
        2406
      ]
    ],
    [
      [
        2438,
        2450
      ]
    ],
    [
      [
        2494,
        2503
      ],
      [
        2575,
        2584
      ]
    ],
    [
      [
        2504,
        2510
      ]
    ],
    [
      [
        2537,
        2542
      ],
      [
        3402,
        3407
      ],
      [
        3492,
        3494
      ],
      [
        4551,
        4553
      ],
      [
        19477,
        19482
      ],
      [
        19612,
        19614
      ],
      [
        19732,
        19737
      ],
      [
        20311,
        20313
      ],
      [
        20351,
        20355
      ],
      [
        20803,
        20805
      ],
      [
        22363,
        22365
      ]
    ],
    [
      [
        2672,
        2682
      ],
      [
        2695,
        2702
      ]
    ],
    [
      [
        2686,
        2693
      ]
    ],
    [
      [
        2732,
        2744
      ]
    ],
    [
      [
        2815,
        2833
      ]
    ],
    [
      [
        2893,
        2896
      ],
      [
        2905,
        2908
      ],
      [
        2910,
        2932
      ],
      [
        3309,
        3312
      ],
      [
        7275,
        7278
      ],
      [
        13770,
        13773
      ],
      [
        13794,
        13797
      ],
      [
        14098,
        14101
      ],
      [
        14675,
        14678
      ],
      [
        14882,
        14885
      ],
      [
        14909,
        14912
      ],
      [
        15039,
        15046
      ],
      [
        16665,
        16668
      ],
      [
        16735,
        16738
      ],
      [
        16904,
        16907
      ],
      [
        16956,
        16959
      ],
      [
        20906,
        20909
      ],
      [
        20944,
        20947
      ],
      [
        21169,
        21172
      ],
      [
        22766,
        22769
      ]
    ],
    [
      [
        2951,
        2962
      ]
    ],
    [
      [
        2965,
        2977
      ]
    ],
    [
      [
        2993,
        3002
      ],
      [
        3784,
        3793
      ],
      [
        6846,
        6855
      ]
    ],
    [
      [
        3015,
        3021
      ],
      [
        3062,
        3070
      ],
      [
        3141,
        3146
      ],
      [
        3187,
        3193
      ],
      [
        3314,
        3320
      ],
      [
        3435,
        3441
      ],
      [
        3616,
        3622
      ],
      [
        3825,
        3833
      ],
      [
        4045,
        4050
      ],
      [
        4201,
        4207
      ],
      [
        4282,
        4284
      ],
      [
        4348,
        4353
      ],
      [
        4366,
        4368
      ],
      [
        4772,
        4777
      ],
      [
        4799,
        4803
      ],
      [
        5599,
        5604
      ],
      [
        5910,
        5918
      ],
      [
        7344,
        7349
      ],
      [
        15058,
        15064
      ],
      [
        16532,
        16540
      ],
      [
        16557,
        16560
      ]
    ],
    [
      [
        3035,
        3040
      ]
    ],
    [
      [
        3044,
        3055
      ],
      [
        3259,
        3272
      ],
      [
        3806,
        3818
      ],
      [
        4243,
        4255
      ],
      [
        4780,
        4792
      ],
      [
        16514,
        16525
      ],
      [
        17784,
        17795
      ]
    ],
    [
      [
        3084,
        3107
      ]
    ],
    [
      [
        3122,
        3140
      ],
      [
        3237,
        3244
      ],
      [
        7365,
        7372
      ]
    ],
    [
      [
        3148,
        3152
      ],
      [
        4165,
        4171
      ],
      [
        4851,
        4856
      ]
    ],
    [
      [
        3279,
        3288
      ],
      [
        3293,
        3300
      ]
    ],
    [
      [
        3351,
        3355
      ]
    ],
    [
      [
        3360,
        3368
      ]
    ],
    [
      [
        3370,
        3377
      ]
    ],
    [
      [
        3418,
        3426
      ],
      [
        3508,
        3517
      ],
      [
        3519,
        3528
      ],
      [
        3651,
        3660
      ]
    ],
    [
      [
        3464,
        3469
      ],
      [
        3687,
        3691
      ]
    ],
    [
      [
        3474,
        3482
      ],
      [
        8311,
        8318
      ],
      [
        15486,
        15493
      ],
      [
        16211,
        16217
      ]
    ],
    [
      [
        3484,
        3491
      ]
    ],
    [
      [
        3549,
        3555
      ],
      [
        6402,
        6409
      ],
      [
        10177,
        10183
      ],
      [
        10185,
        10192
      ],
      [
        10338,
        10345
      ],
      [
        10397,
        10404
      ],
      [
        10433,
        10440
      ],
      [
        10451,
        10458
      ],
      [
        11287,
        11293
      ],
      [
        11437,
        11444
      ],
      [
        11514,
        11521
      ],
      [
        11578,
        11585
      ],
      [
        11642,
        11649
      ],
      [
        11828,
        11834
      ]
    ],
    [
      [
        3560,
        3567
      ]
    ],
    [
      [
        3569,
        3576
      ]
    ],
    [
      [
        3695,
        3701
      ],
      [
        5731,
        5737
      ],
      [
        22793,
        22799
      ]
    ],
    [
      [
        3703,
        3714
      ]
    ],
    [
      [
        3717,
        3729
      ]
    ],
    [
      [
        3731,
        3748
      ],
      [
        3752,
        3761
      ],
      [
        17873,
        17890
      ]
    ],
    [
      [
        3771,
        3781
      ],
      [
        4379,
        4389
      ]
    ],
    [
      [
        3835,
        3856
      ],
      [
        4258,
        4268
      ]
    ],
    [
      [
        3866,
        3876
      ]
    ],
    [
      [
        3896,
        3927
      ],
      [
        8445,
        8455
      ],
      [
        20514,
        20540
      ],
      [
        20590,
        20592
      ]
    ],
    [
      [
        4027,
        4044
      ],
      [
        4369,
        4376
      ]
    ],
    [
      [
        4062,
        4066
      ],
      [
        21041,
        21045
      ],
      [
        21288,
        21292
      ],
      [
        21293,
        21297
      ],
      [
        21327,
        21331
      ],
      [
        21333,
        21340
      ]
    ],
    [
      [
        4107,
        4116
      ],
      [
        4134,
        4136
      ]
    ],
    [
      [
        4144,
        4153
      ],
      [
        4316,
        4318
      ],
      [
        17904,
        17913
      ]
    ],
    [
      [
        4393,
        4401
      ]
    ],
    [
      [
        4411,
        4425
      ]
    ],
    [
      [
        4623,
        4633
      ],
      [
        5649,
        5658
      ]
    ],
    [
      [
        4675,
        4685
      ],
      [
        5636,
        5646
      ]
    ],
    [
      [
        4731,
        4739
      ]
    ],
    [
      [
        4906,
        4913
      ]
    ],
    [
      [
        4914,
        4920
      ],
      [
        5143,
        5149
      ]
    ],
    [
      [
        4922,
        4932
      ],
      [
        5102,
        5112
      ],
      [
        7017,
        7027
      ]
    ],
    [
      [
        4959,
        4972
      ]
    ],
    [
      [
        4975,
        4985
      ],
      [
        14000,
        14010
      ]
    ],
    [
      [
        4988,
        5008
      ],
      [
        5935,
        5955
      ],
      [
        13939,
        13959
      ],
      [
        14102,
        14122
      ]
    ],
    [
      [
        5009,
        5015
      ],
      [
        5152,
        5158
      ]
    ],
    [
      [
        5056,
        5064
      ]
    ],
    [
      [
        5094,
        5100
      ],
      [
        5665,
        5671
      ]
    ],
    [
      [
        5190,
        5208
      ],
      [
        5307,
        5318
      ],
      [
        5614,
        5625
      ],
      [
        7161,
        7178
      ],
      [
        7417,
        7428
      ],
      [
        9835,
        9844
      ],
      [
        13454,
        13471
      ],
      [
        13920,
        13938
      ],
      [
        14197,
        14207
      ],
      [
        15311,
        15329
      ],
      [
        15501,
        15511
      ],
      [
        18029,
        18047
      ],
      [
        18131,
        18142
      ],
      [
        18298,
        18316
      ],
      [
        20015,
        20026
      ],
      [
        22321,
        22338
      ]
    ],
    [
      [
        5239,
        5253
      ],
      [
        5521,
        5535
      ],
      [
        15358,
        15372
      ],
      [
        18795,
        18809
      ]
    ],
    [
      [
        5289,
        5294
      ],
      [
        6943,
        6950
      ],
      [
        13862,
        13867
      ],
      [
        13881,
        13888
      ],
      [
        14046,
        14053
      ]
    ],
    [
      [
        5353,
        5368
      ]
    ],
    [
      [
        5370,
        5378
      ]
    ],
    [
      [
        5380,
        5388
      ]
    ],
    [
      [
        5425,
        5442
      ]
    ],
    [
      [
        5445,
        5468
      ]
    ],
    [
      [
        5502,
        5514
      ]
    ],
    [
      [
        5689,
        5702
      ]
    ],
    [
      [
        5731,
        5745
      ],
      [
        16168,
        16182
      ],
      [
        16184,
        16191
      ]
    ],
    [
      [
        5784,
        5801
      ]
    ],
    [
      [
        5867,
        5876
      ],
      [
        17081,
        17090
      ],
      [
        18071,
        18080
      ]
    ],
    [
      [
        5889,
        5903
      ],
      [
        6084,
        6090
      ],
      [
        6922,
        6936
      ],
      [
        14025,
        14039
      ]
    ],
    [
      [
        5956,
        5960
      ],
      [
        6863,
        6867
      ],
      [
        13960,
        13964
      ],
      [
        13966,
        13973
      ],
      [
        14123,
        14127
      ]
    ],
    [
      [
        5964,
        5981
      ],
      [
        6151,
        6167
      ],
      [
        6451,
        6468
      ],
      [
        6679,
        6696
      ]
    ],
    [
      [
        6001,
        6036
      ]
    ],
    [
      [
        6039,
        6048
      ],
      [
        6221,
        6223
      ]
    ],
    [
      [
        6050,
        6053
      ]
    ],
    [
      [
        6139,
        6147
      ],
      [
        7595,
        7603
      ],
      [
        7638,
        7640
      ]
    ],
    [
      [
        6188,
        6209
      ]
    ],
    [
      [
        6199,
        6209
      ],
      [
        19771,
        19782
      ]
    ],
    [
      [
        6224,
        6230
      ]
    ],
    [
      [
        6244,
        6269
      ]
    ],
    [
      [
        6272,
        6288
      ],
      [
        10728,
        10744
      ]
    ],
    [
      [
        6437,
        6447
      ]
    ],
    [
      [
        6479,
        6506
      ]
    ],
    [
      [
        6521,
        6536
      ]
    ],
    [
      [
        6548,
        6554
      ]
    ],
    [
      [
        6633,
        6644
      ]
    ],
    [
      [
        6657,
        6675
      ]
    ],
    [
      [
        6759,
        6768
      ]
    ],
    [
      [
        6800,
        6811
      ]
    ],
    [
      [
        6885,
        6895
      ],
      [
        7235,
        7245
      ],
      [
        16770,
        16780
      ],
      [
        16860,
        16870
      ],
      [
        18471,
        18481
      ],
      [
        18628,
        18639
      ]
    ],
    [
      [
        6964,
        6975
      ],
      [
        11846,
        11855
      ],
      [
        14011,
        14022
      ],
      [
        14554,
        14565
      ],
      [
        21476,
        21486
      ],
      [
        21496,
        21505
      ],
      [
        21548,
        21558
      ],
      [
        21828,
        21837
      ]
    ],
    [
      [
        6976,
        6987
      ]
    ],
    [
      [
        6998,
        7001
      ],
      [
        7049,
        7052
      ],
      [
        7803,
        7806
      ],
      [
        11767,
        11770
      ],
      [
        11944,
        11947
      ],
      [
        12024,
        12029
      ],
      [
        13394,
        13397
      ],
      [
        13579,
        13582
      ],
      [
        16139,
        16144
      ],
      [
        21055,
        21058
      ]
    ],
    [
      [
        7035,
        7046
      ],
      [
        8190,
        8199
      ]
    ],
    [
      [
        7073,
        7089
      ]
    ],
    [
      [
        7190,
        7200
      ],
      [
        7206,
        7210
      ]
    ],
    [
      [
        7211,
        7226
      ],
      [
        7230,
        7245
      ]
    ],
    [
      [
        7256,
        7261
      ],
      [
        7306,
        7316
      ],
      [
        9773,
        9778
      ],
      [
        14507,
        14513
      ],
      [
        14547,
        14551
      ],
      [
        16718,
        16722
      ],
      [
        16808,
        16810
      ],
      [
        16882,
        16888
      ],
      [
        16936,
        16940
      ],
      [
        16977,
        16980
      ],
      [
        17469,
        17474
      ]
    ],
    [
      [
        7321,
        7333
      ]
    ],
    [
      [
        7373,
        7391
      ]
    ],
    [
      [
        7404,
        7416
      ]
    ],
    [
      [
        7456,
        7462
      ],
      [
        8362,
        8368
      ],
      [
        18348,
        18354
      ],
      [
        20448,
        20454
      ],
      [
        21838,
        21844
      ]
    ],
    [
      [
        7588,
        7591
      ]
    ],
    [
      [
        7686,
        7699
      ],
      [
        21737,
        21753
      ]
    ],
    [
      [
        7829,
        7840
      ],
      [
        10914,
        10922
      ],
      [
        10936,
        10943
      ]
    ],
    [
      [
        8190,
        8202
      ],
      [
        8513,
        8525
      ]
    ],
    [
      [
        8225,
        8230
      ],
      [
        12004,
        12009
      ]
    ],
    [
      [
        8233,
        8255
      ]
    ],
    [
      [
        8289,
        8298
      ],
      [
        16696,
        16707
      ],
      [
        17824,
        17833
      ]
    ],
    [
      [
        8320,
        8331
      ],
      [
        11976,
        11987
      ]
    ],
    [
      [
        9792,
        9805
      ],
      [
        9818,
        9823
      ],
      [
        15397,
        15403
      ],
      [
        15405,
        15415
      ],
      [
        17734,
        17746
      ],
      [
        18730,
        18744
      ],
      [
        20162,
        20168
      ],
      [
        20201,
        20208
      ]
    ],
    [
      [
        10106,
        10111
      ],
      [
        10136,
        10143
      ]
    ],
    [
      [
        10166,
        10173
      ],
      [
        10303,
        10310
      ],
      [
        11398,
        11404
      ],
      [
        11495,
        11503
      ],
      [
        16658,
        16664
      ]
    ],
    [
      [
        10443,
        10446
      ],
      [
        21789,
        21794
      ],
      [
        21969,
        21973
      ]
    ],
    [
      [
        10497,
        10503
      ],
      [
        11294,
        11300
      ]
    ],
    [
      [
        10695,
        10724
      ],
      [
        10770,
        10776
      ]
    ],
    [
      [
        10792,
        10795
      ]
    ],
    [
      [
        11028,
        11034
      ],
      [
        11262,
        11269
      ]
    ],
    [
      [
        11038,
        11063
      ]
    ],
    [
      [
        11069,
        11096
      ]
    ],
    [
      [
        11360,
        11364
      ]
    ],
    [
      [
        11365,
        11376
      ],
      [
        11452,
        11463
      ]
    ],
    [
      [
        11743,
        11766
      ]
    ],
    [
      [
        11793,
        11798
      ],
      [
        17541,
        17546
      ]
    ],
    [
      [
        11858,
        11867
      ]
    ],
    [
      [
        12070,
        12086
      ]
    ],
    [
      [
        13528,
        13544
      ]
    ],
    [
      [
        13547,
        13557
      ]
    ],
    [
      [
        14150,
        14170
      ]
    ],
    [
      [
        14176,
        14180
      ],
      [
        14487,
        14491
      ]
    ],
    [
      [
        14501,
        14513
      ],
      [
        14567,
        14570
      ]
    ],
    [
      [
        14515,
        14530
      ]
    ],
    [
      [
        14594,
        14603
      ],
      [
        14622,
        14629
      ]
    ],
    [
      [
        14647,
        14662
      ]
    ],
    [
      [
        14887,
        14900
      ]
    ],
    [
      [
        14925,
        14939
      ]
    ],
    [
      [
        14942,
        14957
      ]
    ],
    [
      [
        14958,
        14965
      ]
    ],
    [
      [
        15003,
        15019
      ],
      [
        15033,
        15038
      ]
    ],
    [
      [
        15393,
        15396
      ]
    ],
    [
      [
        15431,
        15449
      ],
      [
        17475,
        17493
      ],
      [
        17547,
        17570
      ],
      [
        17980,
        17998
      ],
      [
        18185,
        18203
      ],
      [
        18205,
        18208
      ],
      [
        20043,
        20067
      ],
      [
        20225,
        20249
      ]
    ],
    [
      [
        15453,
        15460
      ],
      [
        17748,
        17755
      ]
    ],
    [
      [
        16218,
        16229
      ]
    ],
    [
      [
        16745,
        16759
      ]
    ],
    [
      [
        16781,
        16785
      ],
      [
        16821,
        16835
      ]
    ],
    [
      [
        17391,
        17401
      ],
      [
        17495,
        17505
      ]
    ],
    [
      [
        17460,
        17474
      ]
    ],
    [
      [
        17577,
        17592
      ]
    ],
    [
      [
        17619,
        17626
      ],
      [
        17628,
        17635
      ],
      [
        17678,
        17684
      ],
      [
        17768,
        17775
      ],
      [
        17806,
        17814
      ],
      [
        17861,
        17868
      ]
    ],
    [
      [
        17653,
        17661
      ]
    ],
    [
      [
        17696,
        17702
      ]
    ],
    [
      [
        17705,
        17716
      ]
    ],
    [
      [
        17777,
        17782
      ]
    ],
    [
      [
        17873,
        17913
      ],
      [
        17915,
        17922
      ]
    ],
    [
      [
        17968,
        17979
      ]
    ],
    [
      [
        18239,
        18246
      ],
      [
        18248,
        18255
      ]
    ],
    [
      [
        18272,
        18281
      ],
      [
        18338,
        18347
      ]
    ],
    [
      [
        18328,
        18333
      ]
    ],
    [
      [
        18434,
        18448
      ]
    ],
    [
      [
        18458,
        18470
      ]
    ],
    [
      [
        18494,
        18500
      ]
    ],
    [
      [
        18640,
        18663
      ]
    ],
    [
      [
        18666,
        18694
      ]
    ],
    [
      [
        18707,
        18744
      ],
      [
        18746,
        18753
      ]
    ],
    [
      [
        19524,
        19530
      ]
    ],
    [
      [
        19535,
        19548
      ]
    ],
    [
      [
        19597,
        19606
      ],
      [
        20356,
        20365
      ]
    ],
    [
      [
        19628,
        19634
      ]
    ],
    [
      [
        19738,
        19740
      ]
    ],
    [
      [
        19762,
        19770
      ]
    ],
    [
      [
        19800,
        19814
      ],
      [
        19897,
        19911
      ],
      [
        20684,
        20698
      ]
    ],
    [
      [
        19918,
        19923
      ],
      [
        20666,
        20671
      ]
    ],
    [
      [
        19934,
        19940
      ],
      [
        20674,
        20680
      ]
    ],
    [
      [
        19958,
        19967
      ]
    ],
    [
      [
        20169,
        20180
      ]
    ],
    [
      [
        20183,
        20200
      ]
    ],
    [
      [
        20558,
        20568
      ],
      [
        20762,
        20772
      ]
    ],
    [
      [
        20605,
        20633
      ]
    ],
    [
      [
        20647,
        20652
      ]
    ],
    [
      [
        20742,
        20753
      ]
    ],
    [
      [
        20785,
        20802
      ]
    ],
    [
      [
        20826,
        20831
      ]
    ],
    [
      [
        20988,
        21013
      ],
      [
        21076,
        21101
      ]
    ],
    [
      [
        21015,
        21039
      ]
    ],
    [
      [
        21183,
        21196
      ]
    ],
    [
      [
        22465,
        22470
      ],
      [
        22741,
        22746
      ]
    ],
    [
      [
        22559,
        22562
      ]
    ],
    [
      [
        22563,
        22577
      ],
      [
        22579,
        22582
      ]
    ]
  ],
  "includes": [
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [
      72,
      73
    ],
    [],
    [],
    [],
    [
      76,
      77
    ],
    [],
    [],
    [
      79,
      80
    ],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [
      100,
      105,
      107
    ],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    []
  ],
  "text": "\n\nПишем первый ML-пайплайн на Airflow: подробный туториал / Habr\n\n\n               Пишем первый ML-пайплайн на Airflow: подробный туториал  Reading time  \n    13 min\n   Views  4.2K Python *Machine learning *Natural Language Processing * \n    Tutorial\n        Ждешь, когда обновятся данные, чтобы запустить переобучение моделиВ этом туториале мы пошагово разберем, как создать с нуля и запустить локально свой первый пайплайн на Airflow. Данный пайплайн специально адаптирован под задачи машинного обучения. В этом примере мы будем загружать новости из открытого источника и использовать NLP-модель для их классификации (zero-shot classification). План:Примеры применения Airflow в проектах с машинным обучением.Знакомство с Airflow: основные понятия и инструменты.Написание тасок для загрузки данных и получения предсказания модели.Запуск Airflow локально через Docker Compose.Знакомство с веб-интерфейсом Airflow.Код доступен на GitHub.Как Airflow используется в проектах с машинным обучениемAirflow хорошо подходит для задач, которые запускаются в указанное время или каждый заданный интервал времени.Apache Airflow - популярный инструмент в проектах с машинным обучением. Он позволяет создавать эффективные и масштабируемые пайплайны, связанные с обработкой данных, обучением и развертыванием моделей.Примеры задач, которые решает Airflow:Регулярное переобучение моделей машинного обучения на новых данных.Получение предсказаний модели в пакетном режиме. Например, раз в час или раз в день.ETL пайплайны, которые загружают данные из разных источников и преобразуют их.Автоматическая генерация отчетов.Ниже приведен пример архитектуры рекомендательной системы, где каждая из 3 частей запускается на Airflow:Feature Engineering: данные от пользователей накапливаются и обрабатываются единоразово в заданное время.Training Pipeline: на основе актуальных данных модель переобучается, например, раз в день.Batch Prediction Pipeline: последняя версия модели используется, чтобы рассчитать новые рекомендации по всем пользователям и сохранить в базу.Архитектура рекомендательной системы на AirflowШаг 3 в этом пайплайне используется получение предсказания модели в пакетном формате. Когда это имеет смысл?Преимущество пакетной обработки: нам не надо беспокоиться о latency модели. Работа с моделью в пакетном режиме, как правило, не требует дополнительной оптимизации и позволяет быстрее довести модель до прода.Недостаток: предсказания имеют запаздывание. Например, рекомендации не будут учитывать real-time фидбек от пользователя. Если для вашей задачи критична работа модели в real-time формате подойдут другие инструменты. В прошлом туториале мы разбирали, как написать ML веб-сервис на FastAPI, который работает с моделью в формате запрос-ответ.Знакомство с Airflow: основные понятия и инструментыПрежде чем начать практическую часть, познакомимся с основными понятиями Apache Airflow.Airflow DAG - примерDAG (Directed Acyclic Graph) - удобный способ организации и визуализации пайплайна. Это структура, где каждая задача представлена узлом, а зависимости между задачами представлены направленными стрелками, указывающими порядок выполнения задач. Граф является направленным, потому что задачи выполняются последовательно в определенном порядке, определяемом зависимостями.Task: \"кирпичи\", из которых состоит DAG. Задачи представляют собой конкретные шаги или операции, которые должны быть выполнены в вашем пайплайне.Operator: Каждая задача выполняется некоторым кодом или скриптом, который вы определяете. Операторы (Operators) представляют собой классы или функции, которые определяют, как будет выполнена каждая задача в пайплайне. Например, есть операторы, отвечающие за выполнение кода на питоне, bash-команд и SQL-запросов. Metadata Database: в этой базе хранятся метаданные о структуре пайплайнов, зависимостях между задачами, расписании выполнения и других параметрах.Webserver: удобный пользовательский интерфейс (UI), позволяющий запускать, мониторить и отлаживать пайплайны. Через веб-интерфейс можно просматривать статус выполнения задач, проверять логи, а также управлять пайплайнами, вносить изменения и контролировать их работу.Scheduler: следит за графом пайплайна, определяет, какие задачи уже могут быть выполнены на основе зависимостей и расписания, и запускает их в соответствии с этой логикой. Он также отслеживает выполнение задач и обновляет их статусы в метаданных.0. Описание задачи и проектирование пайплайнаГлавная цель этого туториала - знакомство с Airflow и самостоятельный запуск пайплайна. То есть, по итогу туториала вы научитесь локально запускать Airflow.Но, для использования Airflow в продакшене необходимы другие инструменты, например, Kubernetes.Apache Airflow предоставляет возможности для создания сложных пайплайнов с множеством задач и зависимостей между ними. Однако, здесь мы ограничимся простым примером графа пайплайна.Наш пайплайнПайплайн будет состоять из 3 задач:Task 1: Подготовка данных - загрузка данных, препроцессинг и сохранение в локальную директорию.Task 2: Предсказание модели - загрузка модели, инференс модели на сохраненных данных.Task 3: Подготовка отчета на основе предсказаний.Task 1 и Task 2 мы хотим запустить в отдельных Docker-контейнерах. Для этого будем использовать DockerOperator.Зачем может понадобиться запускать таски в отдельных контейнерах?Это дает стандартные преимущества контейнеризации: изоляция, гибкость и тд. Например, применительно к ML, код расчета фичей и код предсказания модели могли использовать разные версии scikit-learn.Также DockerOperator позволяет ближе познакомиться с тем, как происходит выполнение задач в разных контейнерах с помощью Kubernetes в продакшен-среде.Task 3 содержит простой код агрегации, поэтому будем использовать PythonOperator.В данном примере пайплайна мы выбрали упрощенный подход и не использовали дополнительные инструменты, чтобы не усложнять настройку Airflow:Для обмена данными между задачами мы использовали локальную директорию data. В реальных проектах часто используются специализированные хранилища данных - Amazon S3, DVC и другие.В качестве источника данных выбран открытый источник - финансовые новости с cnbc.com. В реальных задачах это будут данные из внутренних баз данных или тот же S3.Модель загружали из открытого реестра моделей - Hugging Face Hub. Также сознательно выбрали модель zero-shot classification, которая способна работать с заранее заданным списком классов, не требуя дополнительного дообучения. В реальных проектах это будет специально обученная модель, хранящаяся в реестре моделей, например, MLflow.Таким образом, в данном примере мы использовали упрощенные варианты для целей наглядности и понимания основных концепций. В реальных проектах нужно настраивать и использовать дополнительные инструменты и хранилища данных.С учетом вышесказанного код проекта будет выглядеть следующим образом:Структура проектаdata: вспомогательная директория, будет использоваться для обмена данными между тасками и сохранения результатов.ml_pipeline: содержит код для загрузки и подготовки данных data_loader и код предсказания модели model_prediction. Как уже обсуждалось ранее, каждая таска будет запускаться в отдельном Docker-контейнере, поэтому у обеих таск есть свой Dockerfile.dags: в этой директории находятся файлы, описывающие DAG. Airflow будет использовать эти файлы для планирования и запуска задач в определенном порядке.docker-compose.yml: определяет конфигурацию контейнеров, необходимых для запуска и работы Airflow.1. Загрузка данных, используем DockerДля получения данных о финансовых новостях в этом примере мы будем использовать фид от cnbc.com. Когда мы запрашиваем информацию, он предоставляет нам 30 самых новых новостей из мира финансов. Таким образом, запуская пайплайн раз в день, мы сможем получать каждый день свежие новости.Простейший код для загрузки данных в формате csv будет выглядеть следующим образом:import feedparser\nimport pandas as pd\nNEWS_FEED_URL = \"https://www.cnbc.com/id/19746125/device/rss/rss.xml\"\ndef data_load(data_path: str) -> None:\n    news_feed = feedparser.parse(NEWS_FEED_URL)\n    df = pd.DataFrame(news_feed.entries)\n    df.to_csv(data_path, sep=\"\\t\", index=False)Помимо этого в финальную версию data_load.py добавим:Использование Click и опции командной строки - для возможности гибко задавать параметры при запуске скрипта. Логирование - для возможности отслеживать работу пайплайнов и обнаружения возможных проблем. Позже эти сообщения мы увидим в интерфейсе Airflow.Дополнительную обработку данных.Финальная версия data_load.py выглядит так:import html\nimport logging\nimport click\nimport feedparser\nimport pandas as pd\nNEWS_FEED_URL = \"https://www.cnbc.com/id/19746125/device/rss/rss.xml\"\nCOLUMNS_TO_SAVE = [\"id\", \"published\", \"title\", \"summary\"]\nlogging.basicConfig(level=logging.INFO)\n@click.command()\n@click.option(\"--data_path\", help=\"Path to the input data CSV file\")\ndef data_load(data_path: str) -> None:\n    logging.info(\"Fetching financial news from the RSS feed...\")\n    news_feed = feedparser.parse(NEWS_FEED_URL)\n    logging.info(\"News fetched successfully.\")\n    df = pd.DataFrame(news_feed.entries)[COLUMNS_TO_SAVE]\n    df[\"published\"] = pd.to_datetime(df[\"published\"])\n    df[\"title\"] = df[\"title\"].map(html.unescape)\n    df[\"summary\"] = df[\"summary\"].map(html.unescape)\n    logging.info(f\"Saving the processed data to '{data_path}'...\")\n    df.to_csv(data_path, sep=\"\\t\", index=False)\n    logging.info(\"Data saved successfully.\")\nif __name__ == \"__main__\":\n    data_load()Для подготовки Docker-образа осталось создать:список зависимостей - requirements.txt:feedparser==6.0.10\nclick==8.1.3\npandas==2.0.1Dockerfile:FROM python:3.11\nCOPY requirements.txt data_load.py /workdir/\nWORKDIR /workdir\nRUN pip install -r requirements.txtТаким образом, у нас готовы все файлы для создания Docker-образа. Мы соберем образ и создадим контейнер позже - в разделе про Docker Compose.2. Предсказание модели, zero-shot classificationВ этом примере будем использовать NLP-модель для задачи zero-shot classification.Что такое zero-shot classification?Zero-shot classification (классификация без обучения) - это метод машинного обучения, при котором модель классифицирует объекты на классы, которых не было в процессе обучения модели.Этот подход позволяет модели генерализовать свои знания и классифицировать объекты на основе общего понимания классов, даже если она не имеет конкретного опыта с каждым классом.Для начала определим список классов - тем, на которые мы будем разделять финансовые новости:LABELS = [\n    \"Crypto\",\n    \"SEC\",\n    \"Dividend\",\n    \"Economics\",\n    \"Oil or Gas\",\n    \"IPO\",\n    \"Politics\",\n    \"Buffet\",\n    \"Stock\",\n    \"Other\",\n]Для получения предсказаний загрузим модель valhalla/distilbart-mnli-12-1 из Hugging Face Hub. device=-1 означает, что модель запускается на CPU.from transformers import pipeline\nmodel_hf = pipeline(model=\"valhalla/distilbart-mnli-12-1\", device=-1)Далее загрузим csv файл с новостями, который мы подготовили в предыдущем пункте. Для предсказания будем использовать объединение текста из заголовка новости (title) и ее краткого описания (summary).import pandas as pd\ndf = pd.read_csv(data_path, sep=\"\\t\")\ntexts_for_pred = (df.title + \". \" + df.summary).tolist()Для получения предсказаний передадим модели список текстов texts_for_pred и классы LABELS: pred = model_hf(texts_for_pred, LABELS, multi_label=False)Флаг multi_label определяет, может ли объект быть отнесен к одному или более классам. Когда multi_label=True, модель может присваивать объектам несколько классов одновременно. Таким образом, мы сами придумали название классов на свое усмотрение. Модель делает предсказание по нашим классам без необходимости предварительного обучения. В этом преимущество zero-shot моделей.Благодаря библиотеки transformers код занял всего несколько строк.Выберем предсказание лучшего класса и сохраним результат в json-файл:df[\"label\"] = [x[\"labels\"][0] for x in pred]\ndf.T.to_json(pred_path)На этом код предсказания готов. Добавим логирование и использование Click по аналогии с кодом загрузки данных. Тогда финальная версия model_predict.py будет выглядеть следующим образом:import logging\nimport click\nimport pandas as pd\nfrom transformers import pipeline\nLABELS = [\n    \"Crypto\",\n    \"SEC\",\n    \"Dividend\",\n    \"Economics\",\n    \"Oil or Gas\",\n    \"IPO\",\n    \"Politics\",\n    \"Buffet\",\n    \"Stock\",\n    \"Other\",\n]\nlogging.basicConfig(level=logging.INFO)\n@click.command()\n@click.option(\"--data_path\", help=\"Path to the input data CSV file\")\n@click.option(\"--pred_path\", help=\"Path to save the output JSON file\")\ndef model_predict(data_path: str, pred_path: str) -> None:\n    logging.info(\"Loading the model...\")\n    model_hf = pipeline(model=\"valhalla/distilbart-mnli-12-1\", device=-1)\n    logging.info(\"Model loaded successfully.\")\n    logging.info(f\"Reading data from '{data_path}'...\")\n    df = pd.read_csv(data_path, sep=\"\\t\")\n    logging.info(\"Data read successfully.\")\n    \n    texts_for_pred = (df.title + \". \" + df.summary).tolist()\n    logging.info(\"Performing model prediction...\")\n    pred = model_hf(texts_for_pred, LABELS, multi_label=False)\n    logging.info(\"Prediction completed successfully.\")\n    df[\"label\"] = [x[\"labels\"][0] for x in pred]\n    logging.info(f\"Saving the predictions to '{pred_path}'...\")\n    df.T.to_json(pred_path)\n    logging.info(\"Predictions saved successfully.\")\nif __name__ == \"__main__\":\n    model_predict()\nКод предсказания модели будет также запускаться в отдельном Docker-контейнере. Поэтому аналогично предыдущему пункту мы добавили свои requirements.txt и Dockerfile.Итак, мы подготовили код для 2 компонент нашего пайплайна: загрузки данных и получения предсказания модели. Каждый будет выполняться в отдельном Docker-контейнере. Теперь все готово, чтобы мы перешли к написанию DAG на Airflow.3. Пишем DAGВспомним основные компоненты нашего пайплайна:3 последовательные таски, первые 2 из которых должны запускаться в отдельных Docker-контейнерах.Локальная директория data, которую мы будем использовать для сохранения результатов и обмена данными между тасками.Разберем основные шаги при написании нашего DAG:Локальную директорию data нужно примонтировать к /opt/airflow/data/ - это путь к данным внутри контейнера Airflow.from docker.types import Mount\ndockerops_kwargs = {\n    \"mount_tmp_dir\": False,\n    \"mounts\": [\n        Mount(\n            source=\"<path_to_your_airflow-ml_repo>/data\",\n            target=\"/opt/airflow/data/\",\n            type=\"bind\",\n        )\n    ],\n    ...\n}Определим пути для трех типов файлов: исходные данные, предсказания и файл с результатом. Они используют специальный синтаксис Airflow {{ ds }}, который будет заменен на дату выполнения при запуске DAG.raw_data_path = \"/opt/airflow/data/raw/data__{{ ds }}.csv\"\npred_data_path = \"/opt/airflow/data/predict/labels__{{ ds }}.json\"\nresult_data_path = \"/opt/airflow/data/predict/result__{{ ds }}.json\"Создадим DAG. Декоратор dag создает DAG с названием financial_news с начальной датой сегодня (days_ago(0)) и ежедневным запуском. Функция taskflow представляет собой сам DAG и содержит задачи, формирующие пайплайн.from airflow.decorators import dag\nfrom airflow.utils.dates import days_ago\n# Create DAG\n@dag(\"financial_news\", start_date=days_ago(0), schedule=\"@daily\", catchup=False)\ndef taskflow():\n  ...Создадим две таски для запуска в Docker-контейнерах. Для это будем использовать DockerOperator. Здесь мы указываем имя образа (этот образ будет описан в docker-compose.yml) и команду для запуска питоновского скрипта внутри контейнера.     # Task 1\n    news_load = DockerOperator(\n        task_id=\"news_load\",\n        container_name=\"task__news_load\",\n        image=\"data-loader:latest\",\n        command=f\"python data_load.py --data_path {raw_data_path}\",\n        **dockerops_kwargs,\n    )\n    # Task 2\n    news_label = DockerOperator(\n        task_id=\"news_label\",\n        container_name=\"task__news_label\",\n        image=\"model-prediction:latest\",\n        command=f\"python model_predict.py --data_path {raw_data_path} --pred_path {pred_data_path}\",\n        **dockerops_kwargs,\n    )Создадим последнюю таску, она преобразует полученные предсказания питоновским кодом. Мы будем использовать PythonOperator, который выполнит несложный скрипт группировки предсказаний.    # Task 3\n    news_by_topic = PythonOperator(\n        task_id=\"news_by_topic\",\n        python_callable=aggregate_predictions,\n        op_kwargs={\n            \"pred_data_path\": pred_data_path,\n            \"result_data_path\": result_data_path,\n        },\n    )Установим зависимости между задачами. В нашем случае они выполняются последовательно:news_load >> news_label >> news_by_topicНаконец, создадим и настроим объект DAG в соответствии с заданными параметрами:taskflow()Файл с описанием DAG имеет расширение .py и лежит в директории dags. При запуске Airflow, он сканирует эту директорию (или другую настроенную директорию) в поисках файлов с определением DAG. Когда Airflow обнаруживает файл с определением DAG, он регистрирует его и делает доступным для выполнения по расписанию.Мы закончили писать наш пайплайн, теперь перейдем к настройке и запуску Airflow.4. Запуск Airflow с помощью Docker ComposeДля локального запуска Airflow мы будем использовать Docker Compose. Он помогает запустить Apache Airflow с минимальными усилиями, предоставляя унифицированный и изолированный способ запуска всех компонентов Airflow.У Airflow есть отличная инструкция по запуску с помощью Docker Compose. Там же есть загрузка готового файла docker-compose.yml. Инструкция позволяет запустить Airflow в пару строк.Файл docker-compose.yml имеет раздел services, где определены различные сервисы, которые являются частями кластера Airflow. Каждый сервис имеет свою секцию с настройками, где указывается образ Docker, команда для запуска сервиса, порты, зависимости от других сервисов и другие параметры. В частности здесь описаны сервисы для Metadata Database, Webserver и Scheduler, которые мы упомянали в разделе Знакомство с Airflow. Модификация docker-compose.yml для запуска тасок в отдельных Docker-контейнерах Поскольку мы усложнили настройку Airflow, когда решили запускать таски в отдельных контейнерах, будем использовать свой модифицированный docker-compose.yml. Его можно посмотреть тут.Основные моменты, которые мы изменили для поддержки запуска тасок в Docker-контейнерах:Установили пакет для поддержки работы с Docker:_PIP_ADDITIONAL_REQUIREMENTS: apache-airflow-providers-docker==3.6.0В список volumes добавили монтирование директории с данными и сокета Docker:  volumes:\n    - ${AIRFLOW_PROJ_DIR:-.}/data/:/opt/airflow/data/\n    - /var/run/docker.sock:/var/run/docker.sockРанее в директориях ml_pipeline/data_loader и ml_pipeline/model_prediction мы написали инструкции по созданию Docker-образов, которые импользуются для запуска тасок с помощью DockerOperator. Здесь мы также определяем эти сервисы:  data-loader:\n    build:\n      context: ml_pipeline/data_loader\n    image: data-loader\n    restart: \"no\"\n  model-prediction:\n    build:\n      context: ml_pipeline/model_prediction\n    image: model-prediction\n    restart: \"no\"Добавим сервис docker-socket-proxy:  # Required because of DockerOperator. For secure access and handling permissions.\n  docker-socket-proxy:\n    image: tecnativa/docker-socket-proxy:0.1.1\n    environment:\n      CONTAINERS: 1\n      IMAGES: 1\n      AUTH: 1\n      POST: 1\n    privileged: true\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n    restart: alwaysЗапуск AirflowВозможно, в вашем случае запуск потребует выделения больше памяти для Docker Engine.Перед первым запуском Airflow нужно подготовить окружение.Если вы работаете на Linux перед запуском нужно указать AIRFLOW_UID:echo -e \"AIRFLOW_UID=$(id -u)\" > .envДалее независимо от вашей ОС необходимо выполнить миграцию базы данных и создать первую учетную запись пользователя. Для этого выполните команду:docker compose up airflow-initСозданная учетная запись имеет логин airflow и пароль airflow.Запуск и остановка AirflowДля создания и запуска всех необходимых контейнеров, определенных в файле docker-compose.yml, используется команда:docker compose upВ нашем случае также необходимо предварительно собрать образы data-loader и model-prediction, которые также указаны в файле docker-compose.yml. Поэтому модифицируем команду:docker compose up --buildКогда вы закончите работу и захотите очистить свое окружение, выполните:docker compose down --volumes --rmi allПосле запуска Airflow продолжим работу в веб-интерфейсе.5. Веб-интерфейс Airflow, запуск пайплайнаПользовательский интерфейс Airflow упрощает мониторинг и запуск пайплайнов. Он доступен по адресу http://localhost:8080. На странице входа нужно ввести логин и пароль от учетной записи, в нашем случае airflow и airflow.Страница авторизацииЗапуск и мониторинг пайплайнаНа домашней странице вы увидете список всех дагов, включая дефолтные от Airflow. Здесь можно найти и выбрать созданный нами DAG financial_news.На странице нашего DAG доступна разная информация о пайплайне: графическое представление, время ближайшего запуска, логи запуска, код и многое другое. Графическое представление нашего пайплайнаНе дожидаясь планового запуска пайплайна, запустим DAG, нажав на кнопку старта. Для отслеживания выполнения отдельных тасок, можно нажать на нужную таску и посмотреть ее логи:Логи таски 1Здесь мы можем видеть логи, которые добавили специально для отслеживания выполнения отдельных шагов.После того, как выполнение пайплайна успешно завершилось, посмотрим на результаты. Смотрим результат пайплайна. Как классифицировались новости?Результаты выполнения пайплайна сохранились в data/predict/result__<date>.json.  Изначально мы ставили задачу написать пайплайн, которые будет автоматически загружать актуальные новости из финансового мира и группировать их по заданным нами темам. Посмотрим, что у нас получилось.Результат работы пайплайнаТаким образом, мы справились с поставленной задачей. Новости успешно загружаются и классифицируются. Напомним, что темы заданы нами произвольно, без предварительного обучения модели. ЗаключениеМы подробно рассмотрели, как создать с нуля и запустить локально свой первый ML-пайплайн на Airflow.В этом примере мы написали таски для загрузки новостей из открытого источника и их классификации NLP-моделью (zero-shot classification). Каждая таска выполняется в отдельном Docker-контейнере.Код доступен на GitHub. Вы легко можете воспроизвести пайплайн и изучить его подробнее.Если формат туториалов по инструментам MLOps окажется полезным, буду планировать темы для следующих статей. А пока подписывайтесь на мой телеграм-канал. Там будут анонсы новых статей, а также советы для работы и более короткие мысли по DS/ML/AI.       Tags: airflowdocker composezero-shot classificationdata sciencemlopsмашинное обучениеnlpdagmachine learning  Hubs: PythonMachine learningNatural Language Processing          \n\n\n"
}